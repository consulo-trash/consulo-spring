initial code from https://svn.jetbrains.org/idea/Trunk/